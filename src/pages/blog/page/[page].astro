---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { parseBlogPosts, sortBlogPosts, formatBlogDate, blogPostUrl } from '../../../utils/blog';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  const sortedPosts = sortBlogPosts(parseBlogPosts(posts));

  const pageSize = 9;
  const totalPages = Math.ceil(sortedPosts.length / pageSize);

  // Generate pages 2 onwards (page 1 is handled by index.astro)
  return Array.from({ length: totalPages - 1 }, (_, i) => {
    const page = i + 2;
    const start = (page - 1) * pageSize;
    return {
      params: { page: String(page) },
      props: {
        posts: sortedPosts.slice(start, start + pageSize),
        currentPage: page,
        totalPages,
      },
    };
  });
}

const { posts, currentPage, totalPages } = Astro.props;
---

<BaseLayout title={`Blog - Page ${currentPage}`}>
  <nav class="nr-breadcrumbs" aria-label="Breadcrumb">
    <ol class="nr-breadcrumbs-inner">
      <li><a href="/" class="nr-breadcrumbs-link">Node-RED</a></li>
      <li><a href="/blog/" class="nr-breadcrumbs-link">Blog</a></li>
      <li><span aria-current="page" class="text-white">Page {currentPage}</span></li>
    </ol>
  </nav>

  <div class="max-w-[1200px] mx-auto py-[30px] px-5">
    <h1 class="text-[32px] mb-[30px] pb-[15px] nr-section-heading">Blog - Page {currentPage}</h1>

    <div class="grid grid-cols-[repeat(auto-fill,minmax(340px,1fr))] gap-[25px] lt-md:grid-cols-1">
      {posts.map((post: any) => (
        <article class="nr-card">
          <a href={blogPostUrl(post)} class="block p-[25px] no-underline text-inherit hover:no-underline">
            <h2 class="text-[20px] mb-2.5 text-nr-text">{post.data.title}</h2>
            <time datetime={post.date.toISOString()} class="block text-[13px] text-nr-text-muted mb-2.5">{formatBlogDate(post.date)}</time>
            {post.data.description && <p class="text-sm text-[#666] leading-relaxed">{post.data.description}</p>}
          </a>
        </article>
      ))}
    </div>

    <nav class="mt-10 flex justify-between items-center py-5 border-t border-[#ddd]">
      {currentPage > 1 && (
        <a href={currentPage === 2 ? '/blog/' : `/blog/page/${currentPage - 1}/`} class="nr-btn-primary">
          &larr; Newer posts
        </a>
      )}
      <span class="text-nr-text-muted text-sm">Page {currentPage} of {totalPages}</span>
      {currentPage < totalPages && (
        <a href={`/blog/page/${currentPage + 1}/`} class="nr-btn-primary">
          Older posts &rarr;
        </a>
      )}
    </nav>
  </div>
</BaseLayout>

<style>
  .nr-breadcrumbs-inner li::before {
    content: '/';
    color: rgba(255, 255, 255, 0.6);
    margin: 0 10px;
  }

  .nr-breadcrumbs-inner li:first-child::before {
    content: '';
    margin: 0;
  }
</style>
